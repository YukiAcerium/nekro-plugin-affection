# Nekro-Agent 自动化开发流程设计

## 研究日期

2026-01-30

## 研究目标

设计一套完整的流程，让 AI 能够自动化地开发 Nekro-Agent 插件或系统功能，确保代码质量，避免盲目修改。

---

## 一、核心原则

### 1.1 质量第一

| 原则 | 说明 |
|------|------|
| **不提交未验证的代码** | 每次修改必须经过测试 |
| **小步提交** | 每次 PR 只做一件事 |
| **自测通过** | 本地测试 > CI 测试 |
| **可回滚** | 任何改动都可快速回退 |

### 1.2 开发舒适度

| 痛点 | 解决方案 |
|------|----------|
| 忘记之前的上下文 | 强制记录工作笔记 |
| 代码质量不稳定 | 强制检查清单 |
| 不知道测试覆盖 | 强制生成测试用例 |
| 改动影响未知 | 强制影响分析 |

---

## 二、标准化开发流程

### 2.1 完整流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         自动化开发全流程                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1️⃣ 需求阶段                                                            │
│     ├── [ ] 理解需求 (读文档、源码分析)                                     │
│     ├── [ ] 记录设计 (写入 RESEARCH_NOTES.md)                             │
│     └── [ ] 确认理解 (向用户确认)                                         │
│                                                                         │
│  2️⃣ 设计阶段                                                            │
│     ├── [ ] 架构设计 (组件关系、接口定义)                                   │
│     ├── [ ] 数据模型 (Schema 设计)                                       │
│     ├── [ ] 测试规划 (单元测试、集成测试)                                  │
│     └── [ ] 评审设计 (自我评审)                                          │
│                                                                         │
│  3️⃣ 开发阶段                                                            │
│     ├── [ ] 基础框架 (最小可行代码)                                       │
│     ├── [ ] 核心功能 (实现主要逻辑)                                       │
│     ├── [ ] 错误处理 (边界情况、异常处理)                                  │
│     └── [ ] 代码规范 (linter、formatter)                                 │
│                                                                         │
│  4️⃣ 测试阶段                                                            │
│     ├── [ ] 单元测试 (核心函数测试)                                       │
│     ├── [ ] 集成测试 (多组件协作测试)                                     │
│     ├── [ ] 手动测试 (关键流程验证)                                       │
│     └── [ ] 回归测试 (确保不破坏现有功能)                                 │
│                                                                         │
│  5️⃣ 提交阶段                                                            │
│     ├── [ ] 更新文档 (README、CHANGELOG)                                │
│     ├── [ ] 编写 PR 描述 (清晰说明改动)                                   │
│     └── [ ] 自查清单 (逐项确认)                                          │
│                                                                         │
│  6️⃣ 验证阶段 (CI/CD)                                                   │
│     ├── [ ] CI 检查 (lint、test、build)                                  │
│     ├── [ ] 人工评审 (用户或团队成员)                                     │
│     └── [ ] 合并主分支                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 关键检查点

#### 开发前检查

```markdown
## 开发前清单

### 需求确认
- [ ] 已完整理解需求
- [ ] 已确认边界条件
- [ ] 已识别潜在风险

### 知识储备
- [ ] 已阅读相关源码
- [ ] 已阅读相关文档
- [ ] 已理解 API 契约

### 环境就绪
- [ ] 本地环境可运行
- [ ] 测试环境可访问
- [ ] 版本控制已就绪
```

#### 提交前检查

```markdown
## 提交前清单

### 代码质量
- [ ] 代码通过 linter 检查
- [ ] 代码通过 formatter 格式化
- [ ] 无未使用的导入/变量
- [ ] 注释完整且准确

### 测试覆盖
- [ ] 核心逻辑有单元测试
- [ ] 边界情况有测试
- [ ] 所有测试通过

### 影响分析
- [ ] 已分析对现有功能的影响
- [ ] 已更新相关文档
- [ ] 必要时更新迁移脚本

### 版本控制
- [ ] commit message 清晰
- [ ] PR 描述完整
- [ ] 无临时文件提交
```

---

## 三、自动化工作流设计

### 3.1 Sub-Agent 任务委托

```
┌─────────────────────────────────────────────────────────────┐
│                    主会话 (人类)                            │
│  • 提出需求                                               │
│  • 评审结果                                               │
│  • 确认合并                                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    Sub-Agent (Yuki)                        │
│  • 接收任务                                              │
│  • 执行开发流程                                          │
│  • 提交 PR                                              │
└─────────────────────────────────────────────────────────────┘
                            │
            ┌───────────────┴───────────────┐
            ↓                               ↓
┌─────────────────────┐         ┌─────────────────────┐
│   研究子代理         │         │   开发子代理         │
│  • 源码分析         │         │  • 编写代码         │
│  • 文档学习         │         │  • 运行测试         │
│  • 设计方案         │         │  • 修复问题         │
└─────────────────────┘         └─────────────────────┘
```

### 3.2 子代理任务定义

#### 研究子代理 (Research Agent)

```yaml
agent_id: nekro-agent-researcher
task: |
  研究 Nekro-Agent 的特定功能模块:
  - 模块: {module_name}
  - 目标: 理解其实现、API、测试方式
  - 输出: 
    1. 模块分析报告
    2. API 契约文档
    3. 测试策略建议
```

#### 开发子代理 (Development Agent)

```yaml
agent_id: nekro-agent-developer
task: |
  开发 Nekro-Agent 插件/功能:
  - 功能描述: {feature_description}
  - 设计文档: {research_notes_path}
  - 质量要求:
    * 通过所有静态检查
    * 单元测试覆盖率 > 80%
    * 通过集成测试
  - 输出: 可合并的 PR
```

### 3.3 质量门禁

```
┌─────────────────────────────────────────────────────────────┐
│                    质量门禁检查                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Gate 1: 静态检查                                           │
│  ├── [ ] ruff lint (代码风格)                              │
│  ├── [ ] mypy (类型检查)                                   │
│  └── [ ] security scan (安全扫描)                          │
│                                                             │
│  Gate 2: 单元测试                                          │
│  ├── [ ] pytest --cov > 80%                               │
│  ├── [ ] test/core/ 核心功能测试通过                       │
│  └── [ ] test/integration/ 集成测试通过                    │
│                                                             │
│  Gate 3: 功能验证                                          │
│  ├── [ ] 本地运行测试 (nekro-agent 启动正常)               │
│  ├── [ ] 插件加载测试 (如果适用)                           │
│  └── [ ] 手动关键路径测试                                  │
│                                                             │
│  Gate 4: 文档检查                                          │
│  ├── [ ] README 更新 (如果需要)                           │
│  ├── [ ] 类型注解完整                                      │
│  └── [ ] 示例代码可用                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 四、测试策略

### 4.1 测试金字塔

```
                    ┌─────────────┐
                   /   端到端     \          5%
                  /   (手动验证)   \
                 └─────────────────┘
              ┌─────────────────────────┐
             /      集成测试            \      25%
            /      (多组件协作)         \
           └───────────────────────────┘
      ┌───────────────────────────────────┐
     /          单元测试                    \   70%
    /          (核心逻辑)                   \
   └─────────────────────────────────────┘
```

### 4.2 测试要求

#### 单元测试要求

```python
# test_core_xxx.py

def test_核心功能正常情况():
    """测试正常情况下的核心功能"""
    # Given
    input_data = ...
    # When
    result = my_function(input_data)
    # Then
    assert result == expected

def test_边界情况_empty输入():
    """测试空输入处理"""
    # Given
    input_data = None
    # When/Then
    with pytest.raises(ValueError):
        my_function(input_data)

def test_边界情况_超长输入():
    """测试超长输入处理"""
    # Given
    input_data = "x" * 10000
    # When
    result = my_function(input_data)
    # Then
    assert len(result) <= 1000
```

#### 集成测试要求

```python
# test_integration_xxx.py

async def test_插件加载流程():
    """测试插件完整加载流程"""
    # Given
    plugin_path = Path("./test_plugin")
    
    # When
    plugin = await load_plugin(plugin_path)
    
    # Then
    assert plugin is not None
    assert plugin.name == "test_plugin"
    assert len(plugin.methods) > 0
```

### 4.3 测试生成规范

```markdown
## 测试生成模板

### 核心功能测试 (必填)

```python
def test_{function_name}_normal_case():
    """正常情况测试"""
    # Arrange: 准备测试数据
    # Act: 调用被测函数
    # Assert: 验证结果
```

### 边界情况测试 (必填)

```python
def test_{function_name}_edge_cases():
    """边界情况测试
    - 空输入
    - 极端值
    - None 值
    - 超长输入
    """
```

### 错误处理测试 (必填)

```python
def test_{function_name}_error_handling():
    """错误处理测试
    - 无效输入
    - 异常情况
    """
```

---

## 五、工作空间管理

### 5.1 项目结构

```
yuki-research/
├── 01_projects/                    # 长期项目
│   └── nekro-agent-xxx/           # 具体项目
│       ├── README.md              # 项目说明
│       ├── 00_requirements.md     # 需求文档
│       ├── 01_design.md           # 设计文档
│       ├── 02_implementation.md   # 实现笔记
│       ├── 03_testing.md          # 测试记录
│       ├── 04_review.md           # 评审记录
│       ├── src/                   # 源代码
│       ├── tests/                 # 测试代码
│       └── artifacts/             # 生成物
│
├── 02_drafts/                     # 草稿
├── 03_tmp/                        # 临时文件
└── 04_archive/                    # 归档
```

### 5.2 工作流程

#### 新任务接收

```markdown
# 任务模板

## 任务描述
- 来源: {用户/Issue/PR}
- 描述: {详细描述}
- 目标: {预期结果}

## 验收标准
- [ ] 标准 1
- [ ] 标准 2
- [ ] 标准 3

## 约束条件
- 限制 1
- 限制 2

## 输出
- 产物 1
- 产物 2
```

#### 每日工作记录

```markdown
# 工作记录 - YYYY-MM-DD

## 今日进度
- [ ] 任务 1: 完成了 X%
- [ ] 任务 2: 完成了 Y%

## 发现的问题
- 问题 1: 描述 + 影响
- 问题 2: 描述 + 影响

## 明日计划
- [ ] 任务 1: 继续开发
- [ ] 任务 2: 开始测试

## 待确认事项
- 问题 1: 需要用户确认
```

---

## 六、代码质量保证机制

### 6.1 Self-Correction 循环

```
┌─────────────────────────────────────────────────┐
│              自我纠正工作流                       │
├─────────────────────────────────────────────────┤
│                                                  │
│   1. 编写代码                                    │
│        ↓                                         │
│   2. 运行静态检查 (ruff, mypy)                    │
│        ↓                                         │
│   3. ❌ 检查失败?                                │
│        ↓ 是                                      │
│   4. 修复问题                                    │
│        ↓                                         │
│   5. 重新检查                                    │
│        ↓                                         │
│   6. ❌ 还有问题?                                │
│        ↓ 是                                      │
│   7. 记录问题，跳过（需要用户帮助）                │
│                                                  │
└─────────────────────────────────────────────────┘
```

### 6.2 检查清单自动执行

```bash
#!/bin/bash
# pre-commit-check.sh

set -e

echo "=== 代码质量检查 ==="

# 1. 代码格式
echo "1. 检查代码格式..."
ruff check src/ tests/
ruff format --check src/ tests/

# 2. 类型检查
echo "2. 检查类型..."
mypy src/ --ignore-missing-imports

# 3. 测试
echo "3. 运行测试..."
pytest tests/ -v --cov=src/ --cov-min=80

# 4. 构建
echo "4. 检查构建..."
cd /path/to/nekro-agent
pip install -e . -q

echo "=== 所有检查通过 ==="
```

### 6.3 代码评审清单

```markdown
## 自查清单 (提交前必填)

### 功能性
- [ ] 代码实现了需求描述的功能
- [ ] 边界情况有处理
- [ ] 错误信息清晰
- [ ] 日志记录适当

### 可维护性
- [ ] 函数/类有文档注释
- [ ] 复杂逻辑有注释说明
- [ ] 命名清晰有意义
- [ ] 无硬编码数值

### 可测试性
- [ ] 核心函数可单元测试
- [ ] 无不可测试的代码
- [ ] 测试覆盖率 > 80%

### 安全性
- [ ] 无敏感信息泄露
- [ ] 输入有验证
- [ ] 无 SQL 注入风险
- [ ] 无命令注入风险

### 兼容性
- [ ] 考虑跨平台
- [ ] 依赖版本兼容
- [ ] 向后兼容
```

---

## 七、输出标准

### 7.1 PR 描述模板

```markdown
## 功能描述
简要描述这个 PR 解决的问题

## 改动类型
- [ ] 新功能 (feature)
- [ ] Bug 修复 (bugfix)
- [ ] 重构 (refactor)
- [ ] 文档 (docs)
- [ ] 测试 (test)

## 改动内容
- 列表说明主要改动

## 测试情况
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 手动测试通过

## 影响范围
- 影响模块 A
- 影响模块 B

## 相关文档
- 文档链接

## 截图/示例
(如有需要)
```

### 7.2 代码注释标准

```python
def calculate_embedding(text: str) -> List[float]:
    """计算文本的向量嵌入
    
    使用指定的嵌入模型将文本转换为向量表示。
    
    Args:
        text: 输入文本，最大长度 8192 字符
        
    Returns:
        嵌入向量，维度 1024
        
    Raises:
        ValueError: 文本为空或超出长度限制
        RuntimeError: 嵌入服务不可用
        
    Example:
        >>> embedding = calculate_embedding("Hello, world!")
        >>> len(embedding)
        1024
    """
```

---

## 八、持续改进

### 8.1 定期回顾

```markdown
## 流程回顾 (每月)

### 回顾问题
1. 哪些流程步骤经常被跳过？
2. 哪些检查最常失败？
3. 哪些问题重复出现？

### 改进行动
- [ ] 优化检查清单
- [ ] 添加自动化脚本
- [ ] 更新文档
```

### 8.2 知识积累

```
┌─────────────────────────────────────────────────────────┐
│                    知识库                              │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  最佳实践:                                              │
│  ├── Python 代码规范                                    │
│  ├── 测试策略选择                                       │
│  ├── 错误处理模式                                      │
│  └── 性能优化技巧                                      │
│                                                          │
│  问题解决方案:                                          │
│  ├── 常见错误及修复                                     │
│  ├── 配置问题排查                                       │
│  └── 依赖冲突解决                                       │
│                                                          │
│  模板库:                                                │
│  ├── 功能开发模板                                       │
│  ├── 测试用例模板                                       │
│  └── PR 描述模板                                       │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 九、总结

### 9.1 核心流程

```
需求 → 设计 → 开发 → 测试 → 提交 → 验证 → 合并
  ↓       ↓       ↓       ↓       ↓       ↓       ↓
用户确认   自我评审  静态检查  全覆盖    自查     CI       人工
           设计评审  单元测试  集成测试  清单     通过     评审
```

### 9.2 关键原则

| 原则 | 实践 |
|------|------|
| **质量优先** | 未验证不提交 |
| **小步提交** | 每次只做一件事 |
| **自测通过** | CI 失败不合并 |
| **文档完整** | 无文档不合并 |
| **可回滚** | 改动可快速恢复 |

### 9.3 最终目标

> **让 AI 能够独立、高质量地完成 Nekro-Agent 的插件和系统功能开发，同时保证代码可维护、可测试、可追溯。**

---

## 附录：工具清单

| 工具 | 用途 |
|------|------|
| ruff | 代码检查 + 格式化 |
| mypy | 类型检查 |
| pytest | 单元测试 |
| pytest-cov | 测试覆盖率 |
| pre-commit | Git Hook 管理 |
| taskipy | 任务模板 |

---

## 附录：检查脚本

```bash
#!/bin/bash
# validate-submission.sh

checklist=(
    "代码通过 ruff 检查"
    "代码通过 mypy 检查"
    "单元测试覆盖率 > 80%"
    "所有 pytest 测试通过"
    "核心功能有集成测试"
    "代码有完整注释"
    "README 已更新"
    "PR 描述完整"
)

echo "=== 提交前检查 ==="
for item in "${checklist[@]}"; do
    echo "[ ] $item"
done

echo ""
echo "请逐项确认完成后，再提交代码。"
```

---

## 附录：模板索引

| 模板 | 文件 | 用途 |
|------|------|------|
| 项目模板 | 01_projects/xxx/README.md | 新项目初始化 |
| 任务模板 | 任务描述 | 任务接收 |
| 工作记录 | 03_tmp/daily_YYYY-MM-DD.md | 每日记录 |
| 检查清单 | scripts/checklists/ | 提交前自查 |
| PR 模板 | .github/PULL_REQUEST_TEMPLATE.md | PR 描述 |
| 测试模板 | tests/conftest.py | 测试用例 |
