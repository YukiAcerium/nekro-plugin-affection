# NA_v2.2.0：异步纪元与插件能力增强

⚠️注意: 本更新为次要版本更新，向后兼容 v2.1.x 版本。建议所有用户升级以获得最新功能和问题修复。

## 重点更新：异步任务系统

本次更新中，我们为 NekroAgent 插件系统引入了完整的异步任务框架，允许插件执行长时间运行的后台任务而不会阻塞主 AI 的对话能力。

### 异步任务系统

- **变更详情**: 我们为插件系统引入了完整的异步任务框架，允许插件执行长时间运行的后台任务而不会阻塞主 AI 的对话能力。

- **对您的影响**:
  - 现在可以开发真正"不打断对话"的插件
  - 支持任务进度追踪和实时状态报告
  - 支持任务取消和外部信号等待
  - 任务完成后可自动通知主 Agent

感谢 @KroMiose 贡献了此功能的实现

### 🌟 示范插件：WebApp 智能开发助手

基于异步任务系统的首个示范插件 **[nekro-plugin-webapp](https://github.com/KroMiose/nekro-plugin-webapp)** 现已发布！

**WebApp 智能开发助手** 是一个 AI 驱动的 Web 应用开发工具，利用异步任务系统实现单 Agent 原生 Tool Call 架构：

- **主对话不阻塞**：Developer Agent 在后台独立工作，用户与 NekroAgent 主框架的交互完全不受影响
- **实时状态感知**：主 Agent 通过提示词注入实时查看任务工作进度
- **双向通信**：用户可以随时发送反馈补充，任务完成后自动通知
- **一键部署**：AI 自动将生成的代码编译并部署为在线网页（基于 Cloudflare Workers）

**工作流程**：
```
用户：帮我创建一个计时器应用

AI：✅ 已创建任务 [Web_0001]
📝 计时器应用开发

Developer Agent 正在工作...
  📝 分析需求 → 💻 编写代码 → ✅ 编译验证 → 🚀 部署上线

[系统] ✅ [WebDev Task Web_0001] (成果)
网页已部署完成！
🔗 预览链接: https://your-worker.pages.dev/abc12345
```

**推荐使用**：WebApp 插件充分展示了异步任务系统的能力，是开发"不打断对话"插件的最佳参考范例。

👉 **[WebApp 插件仓库](https://github.com/KroMiose/nekro-plugin-webapp)** | **[部署文档](https://github.com/KroMiose/nekro-plugin-webapp/blob/main/DEPLOYMENT.md)**

---

## 功能增强

### OneBot JSON 卡片消息支持

- **变更详情**: OneBot V11 适配器现在完整支持 JSON 卡片消息的解析和格式化，实现了完整的卡片信息提取和文本摘要生成。

- **对您的影响**: 可以发送和接收更丰富的 JSON 卡片格式消息，实现更美观的 UI 展示。

感谢 @Furina 贡献了此功能的实现

### 插件生命周期回调

- **变更详情**: 新增插件启用和禁用的生命周期回调支持，实现更规范的插件生命周期管理。

- **对您的影响**:
  - 插件可以在启用时自动初始化资源
  - 插件可以在禁用时自动清理资源
  - 实现更规范的插件生命周期管理

感谢 @luoyunfa 贡献了此功能的实现

### 插件加载错误展示

- **变更详情**: 加载异常的插件现在会在插件列表中呈现错误信息，帮助用户快速定位插件加载问题。

- **对您的影响**: 可以更方便地诊断插件加载问题，快速定位错误原因（如导入错误、配置错误、依赖缺失等）。

感谢 @Furina 贡献了此功能的实现

### 嵌入生成增强

- **变更详情**: 为嵌入请求添加超时配置，为图片下载添加超时管理，增强嵌入生成的重试机制。

- **对您的影响**: 更稳定的向量数据库操作，减少超时导致的嵌入生成失败。

### PyPI 镜像源和代理配置

- **变更详情**: 新增 PyPI 镜像源和代理配置功能，支持配置多个 PyPI 镜像源和代理。

- **对您的影响**: 在网络受限环境中可以更顺畅地安装依赖，支持配置多个 PyPI 镜像源和代理。

感谢 @XG2020 贡献了此功能的实现

### 绘画插件 Google 原生 API 适配

- **变更详情**: 绘画插件聊天画图功能新增 Google 原生 API 适配。

- **对您的影响**: 支持更多绘图 API 提供商，包括 Google 的原生图片生成接口。

感谢 @ZerBC 贡献了此功能的实现

### SSE 适配器 @ 提及解析

- **变更详情**: SSE 适配器新增 @ 提及解析功能，支持多种格式的 @ 提及。

- **对您的影响**: 更完整的 @ 提及消息支持，可以正确识别和解析各种格式的 @ 提及。

### SDK 发布和频道名称处理

- **变更详情**: 新增 SSE SDK 项目，自动化 SDK 发布流程。

- **对您的影响**: 更便捷的 SDK 集成能力，开发者可以更方便地使用和发布 SSE SDK。

---

## 性能优化与问题修复

### 核心系统

- **修复前端复制失效 bug (#187)**: 修复 WebUI 中消息复制功能失效问题
- **修复沙盒依赖问题**: 修复沙盒环境依赖配置错误
- **修复构建和启动入口问题**: 修复 Docker 构建和进程启动配置
- **修复历史上下文长度计算**: 优化历史上下文长度计算逻辑
- **修复聊天密钥分割逻辑**: 限制 chat_key 分割为两部分，避免过长

### 数据库和配置

- **增加用户 ID 和聊天密钥的最大长度**: 将最大长度从 64 增加到 128
- **简化 PostgreSQL 配置**: 优化开发环境 Docker Compose 配置
- **修复默认数据路径**: 修复默认数据目录配置

### 消息和文件

- **修复上传文件时使用文件名**: 修复上传文件使用文件名而非完整路径
- **修复历史记录 remote_url 显示**: 修复历史记录中 remote_url 显示问题
- **修复图片 vision 不匹配问题**: 修复图片 vision 不匹配问题
- **优化嵌入生成的错误处理和超时管理**: 添加重试机制和超时配置

### 其他

- **修复仪表盘时间显示**: 改进时间戳解析逻辑 (#173)
- **修复沙盒镜像构建**: 优化沙盒 Docker 镜像构建流程
- **修复发布工作流**: 优化 GitHub Actions 发布流程
- **修复 README 文档**: 修正文档中的错误信息

---

## 开发体验

### 包管理器迁移

- **变更详情**: 从 Poetry 迁移到 uv 包管理器。新增预览版本构建工作流。

- **对您的影响**:
  - 更快的依赖安装（uv 比 Poetry 快 10-100 倍）
  - 更简洁的开发流程
  - 更方便的预览版本构建和发布

---

## New Contributors

* @YukiAcerium made their first contribution in https://github.com/KroMiose/nekro-agent/pull/174
* @XG2020 made their first contribution in https://github.com/KroMiose/nekro-agent/pull/180
* @ZerBC made their first contribution in https://github.com/KroMiose/nekro-agent/pull/176

**Full Changelog**: https://github.com/KroMiose/nekro-agent/compare/v2.1.0...v2.2.0
