# 2026-01-29 - Gmail Pub/Sub 配置

## 完成的工作

### Gmail 配置
- 创建 GCP 项目 `yuki-gmail-bot`
- 启用 Gmail 和 Pub/Sub APIs
- 创建 Pub/Sub 主题 `projects/yuki-gmail-bot/topics/gog-gmail-watch`
- 配置 OAuth 2.0 客户端凭证
- 授权 gogcli 访问 Gmail

### Clawdbot 配置
- 启用 hooks 功能
- 配置 Gmail preset + custom mappings
- token: `Rz1TZ2hghZ1wzahAX38AGM9J9fzTaoIJ4CoCBTLH9U=`
- Discord channel 配置为 `allow_all`

### 运行的服务
```bash
# Gmail Watch
gog gmail watch start --account=yukiacerium@gmail.com --label=INBOX

# gog serve (后台)
gog gmail watch serve \
  --bind=127.0.0.1 --port=8788 \
  --path=/gmail-pubsub \
  --token=<hook_token> \
  --hook-url=http://127.0.0.1:18789/hooks/gmail \
  --hook-token=<hook_token>
```

## 重要发现

### Tailscale Funnel 是必须的
Gmail Pub/Sub 推送需要公网 HTTPS 端点。当前配置只有本地测试可用，公网推送不可用。

### 邮件处理流程
```
邮件 → Gmail → Pub/Sub → gog serve → Clawdbot webhook → AI → Discord
```

## 待办
- [x] ~~配置 Tailscale Funnel 使公网推送可用~~
- [ ] 完善 Gmail webhook mappings
- [ ] 测试完整邮件处理流程

## 收到邮件记录
- **20:23** 收到 li_xiangff@163.com 邮件："再试一次，通过dc联系我"
  - 已回复邮件告知已在 Discord 上联系
  - Discord 上的消息已发送，等待回复

## 使用的命令
```bash
gog auth credentials set <json_file>
gog auth add yukiacerium@gmail.com --services=gmail
gog gmail watch start --account=yukiacerium@gmail.com
clawdbot gateway restart
```
