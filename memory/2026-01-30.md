# 2026-01-30 工作记录

## 沙盒权限问题深度分析

### 问题根源
- `docker/install.sh` 第 237 行 `sudo chmod -R 777` 不解决所有权问题
- 容器使用 nobody 用户，文件归属 nobody:nobody
- sudo 运行后文件变成 root:root，普通用户无法编辑

### 关键代码问题点
| 文件 | 行号 | 问题 |
|------|------|------|
| runner.py | 171-175 | chmod 777 不解决所有权 |
| ext_caller_code.py | 73 | 默认容器内路径 |
| sandbox.sh | 4,8 | 使用 sudo 运行 docker |
| dockerfile | 54-56 | 设置 nobody 用户 |

---

## 兼容性分析结论

### 用户群体影响
| 用户群体 | 当前状态 | 影响 |
|----------|----------|------|
| Docker 部署 | install.sh | 权限混乱 |
| 开发环境 | nb run | 需要 sudo |
| 升级用户 | 旧版本 | 需要迁移脚本 |

### 解决方案
1. **短期**: 迁移脚本 `migrate_sandbox_permissions.sh`
2. **中期**: 修改容器使用主机用户身份运行
3. **长期**: 统一在线升级脚本

---

## 统一升级方案评估

### 新升级命令设计
```bash
curl -fsSL https://ep.nekro.ai/e/KroMiose/nekro-agent/main/upgrade.sh | bash
```

### 核心功能
1. ✅ 检查环境
2. ✅ 自动备份
3. ✅ **权限修复** (关键)
4. ✅ 清理容器
5. ✅ 更新服务
6. ✅ 验证结果

### 风险评估
| 风险 | 级别 | 缓解措施 |
|------|------|----------|
| 脚本执行失败 | 🔴 高 | 错误处理 + 回滚 |
| 权限修复破坏配置 | 🔴 高 | 备份优先 |
| 并发升级冲突 | 🟡 中 | 锁机制 |

### 实施计划
- Week 1-2: 开发 upgrade.sh
- Week 3-4: 自动化测试
- Week 5: 灰度发布 → 全量

---

## 修正：Nekro-Agent 实际测试方式

### 核心测试方式
| 类型 | 命令 | 说明 |
|------|------|------|
| **插件加载测试** | `uv run bot --load-test` | 验证所有插件能否正确加载（CI） |
| **代码检查** | `uv run ruff check .` | 代码风格和质量 |
| **格式检查** | `uv run ruff format --check .` | 代码格式 |

### 重要发现
- **没有单元测试框架**: 项目未配置 pytest
- **主要测试是加载测试**: 验证 NoneBot2 插件系统正常工作
- **沙盒无测试**: 沙盒环境独立运行，无测试用例

### 实际测试流程
```
1. ruff lint (代码检查)
2. ruff format --check (格式)
3. bot --load-test (插件加载)
4. CI 验证通过 → 可合并
```

### 核心原则
1. **质量优先**: 未验证不提交
2. **小步提交**: 每次只做一件事
3. **自测通过**: CI 失败不合并
4. **可回滚**: 改动可快速恢复

---

## 输出文档

| 文档 | 路径 |
|------|------|
| 权限分析 | 01_projects/nekro-agent-sandbox-analysis/01_sandbox_permission_analysis.md |
| 兼容性分析 | 01_projects/nekro-agent-sandbox-analysis/02_compatibility_analysis.md |
| 统一升级评估 | 01_projects/nekro-agent-sandbox-analysis/03_unified_upgrade_assessment.md |
| 自动化流程 | 01_projects/nekro-agent-sandbox-analysis/04_automation_development_flow.md |

---

## 待办（修正）

- [ ] 基于实际测试方式重新设计开发流程
- [ ] 实现 upgrade.sh 脚本（测试：插件加载）
- [ ] 配置 EP 边缘函数
- [ ] 编写回滚脚本
- [ ] 插件开发示例（验证 load-test）
